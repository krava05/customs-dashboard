import os
import streamlit as st
from google.cloud import bigquery
import pandas as pd
import json

# --- –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ü–ê–†–û–õ–Ø ---
def check_password():
    """Returns `True` if the user had a correct password."""

    def password_entered():
        """Checks whether a password entered by the user is correct."""
        if st.session_state["password"] == st.secrets["APP_PASSWORD"]:
            st.session_state["password_correct"] = True
            del st.session_state["password"]
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.text_input(
            "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É", type="password", on_change=password_entered, key="password"
        )
        return False
    elif not st.session_state["password_correct"]:
        st.error("üòï –ü–∞—Ä–æ–ª—å –Ω–µ–≤—ñ—Ä–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")
        st.text_input(
            "–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É", type="password", on_change=password_entered, key="password"
        )
        return False
    else:
        return True

# --- –û–°–ù–û–í–ù–û–ô –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
if check_password():
    # --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
    PROJECT_ID = "ua-customs-analytics"
    TABLE_ID = f"{PROJECT_ID}.ua_customs_data.declarations"

    # --- –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---
    if 'GCP_CREDENTIALS' in st.secrets:
        creds_dict = dict(st.secrets["GCP_CREDENTIALS"])
        creds_json_str = json.dumps(creds_dict)
        with open("gcp_credentials.json", "w") as f:
            f.write(creds_json_str)
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = "gcp_credentials.json"
    else:
        JSON_KEY_PATH = "ua-customs-analytics-08c5189db4e4.json"
        os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = JSON_KEY_PATH

    # --- –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• ---
    @st.cache_data
    def load_data(query):
        try:
            client = bigquery.Client(project=PROJECT_ID)
            df = client.query(query).to_dataframe()
            return df
        except Exception as e:
            st.error(f"–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ BigQuery: {e}")
            return pd.DataFrame()

    # --- –Ü–ù–¢–ï–†–§–ï–ô–° –ó–ê–°–¢–û–°–£–ù–ö–£ ---
    st.set_page_config(layout="wide")
    st.title("–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ú–∏—Ç–Ω–∏—Ö –î–∞–Ω–∏—Ö")
    st.sidebar.header("–§—ñ–ª—å—Ç—Ä–∏")
    nazva_kompanii = st.sidebar.text_input("–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó")
    kod_yedrpou = st.sidebar.text_input("–ö–æ–¥ –Ñ–î–†–ü–û–£")
    kraina_partner = st.sidebar.text_input("–ö—Ä–∞—ó–Ω–∞-–ø–∞—Ä—Ç–Ω–µ—Ä")
    kod_uktzed = st.sidebar.text_input("–ö–æ–¥ –£–ö–¢–ó–ï–î")
    direction = st.sidebar.selectbox("–ù–∞–ø—Ä—è–º–æ–∫", ["–í—Å–µ", "–Ü–º–ø–æ—Ä—Ç", "–ï–∫—Å–ø–æ—Ä—Ç"])
    query = f"SELECT * FROM `{TABLE_ID}` WHERE 1=1"
    if nazva_kompanii: query += f" AND LOWER(nazva_kompanii) LIKE LOWER('%{nazva_kompanii}%')"
    if kod_yedrpou: query += f" AND kod_yedrpou LIKE '%{kod_yedrpou}%'"
    if kraina_partner: query += f" AND LOWER(kraina_partner) LIKE LOWER('%{kraina_partner}%')"
    if kod_uktzed: query += f" AND kod_uktzed LIKE '%{kod_uktzed}%'"
    if direction != "–í—Å–µ": query += f" AND napryamok = '{direction}'"
    query += " LIMIT 5000"
    df = load_data(query)
    if not df.empty:
        st.success(f"–ó–Ω–∞–π–¥–µ–Ω–æ {len(df)} –∑–∞–ø–∏—Å—ñ–≤ (–ø–æ–∫–∞–∑–∞–Ω–æ –¥–æ 5000)")
        df['mytna_vartist_hrn'] = pd.to_numeric(df['mytna_vartist_hrn'], errors='coerce')
        df['vaha_netto_kg'] = pd.to_numeric(df['vaha_netto_kg'], errors='coerce')
        total_value = df['mytna_vartist_hrn'].sum()
        total_weight = df['vaha_netto_kg'].sum()
        col1, col2 = st.columns(2)
        col1.metric("–ó–∞–≥–∞–ª—å–Ω–∞ –º–∏—Ç–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å, –≥—Ä–Ω", f"{total_value:,.2f}")
        col2.metric("–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞, –∫–≥", f"{total_weight:,.2f}")
        st.dataframe(df)
    else:
        st.warning("–ó–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
